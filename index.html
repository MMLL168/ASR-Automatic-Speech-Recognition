<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="基於 ESP32-S3 之離線語音識別產品深度技術報告 - Marlon's Engineering Log">
    <title>Project: EdgeVox | 離線語音識別技術報告</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class', // 啟用 class 模式的手動切換
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        tech: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        ameba: {
                            500: '#8A2BE2', // Purple for Ameba
                            600: '#7B1FA2',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            line-height: 1.5;
            white-space: pre; /* 保留完整格式 */
        }
        
        /* Syntax highlighting simulation */
        .token-keyword { color: #c678dd; }
        .token-function { color: #61afef; }
        .token-string { color: #98c379; }
        .token-comment { color: #7f848e; font-style: italic; }
        .token-number { color: #d19a66; }
        .token-type { color: #e5c07b; }
        .token-preproc { color: #e06c75; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-gray-800 dark:text-slate-300 antialiased font-sans flex h-screen overflow-hidden transition-colors duration-300">

    <!-- Mobile Header -->
    <div class="md:hidden fixed w-full bg-slate-900 text-white z-50 flex justify-between items-center p-4 shadow-md border-b border-slate-700">
        <span class="font-bold text-lg"><i class="fas fa-wave-square mr-2"></i>Project: EdgeVox</span>
        <div class="flex items-center space-x-4">
            <button id="mobile-theme-toggle" class="text-slate-300 hover:text-white focus:outline-none">
                <i class="fas fa-moon"></i>
            </button>
            <button id="mobile-menu-btn" class="text-white focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="transform -translate-x-full md:translate-x-0 transition-transform duration-300 fixed md:static inset-y-0 left-0 w-80 bg-slate-900 text-slate-300 flex flex-col z-40 h-full border-r border-slate-800 shrink-0 shadow-xl md:shadow-none">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold text-white tracking-wide"><i class="fas fa-wave-square text-tech-500 mr-2"></i>EdgeVox</h1>
            <p class="text-xs mt-2 text-slate-400">Offline Speech Recognition</p>
            <div class="mt-4 flex items-center space-x-2">
                <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-mono text-green-400">STATUS: FULL RESTORE v3.2</span>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-1">
            <a href="#summary" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-home w-6 text-center"></i> 執行摘要與背景</a>
            
            <div class="pt-4 pb-1 text-xs font-semibold text-slate-500 uppercase tracking-wider">ESP32-S3 系統核心</div>
            <a href="#hardware" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-memory w-6 text-center"></i> 核心硬體 (Dual Display)</a>
            <a href="#display-matrix" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-tv w-6 text-center"></i> 顯示方案決策</a>
            <a href="#schematic" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-bezier-curve w-6 text-center"></i> 電路與 PCB 設計</a>
            <a href="#acoustic" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-volume-up w-6 text-center"></i> 聲學結構工程</a>
            <a href="#software" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-code w-6 text-center"></i> 軟體與演算法</a>
            <a href="#power" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-battery-half w-6 text-center"></i> 電源管理</a>
            
            <div class="pt-4 pb-1 text-xs font-semibold text-slate-500 uppercase tracking-wider">Ameba Mini 擴充系統</div>
            <a href="#ameba-mini" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-purple-400"><i class="fas fa-video w-6 text-center"></i> Ameba Mini 系統規格</a>
            <a href="#comparison" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-purple-400"><i class="fas fa-balance-scale w-6 text-center"></i> 雙平台對比與選型</a>

            <div class="pt-4 pb-1 text-xs font-semibold text-slate-500 uppercase tracking-wider">實作與部署 (完整版)</div>
            <a href="#implementation" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-green-400"><i class="fas fa-laptop-code w-6 text-center"></i> 實作開發指南</a>
            <a href="#acquisition-deep-dive" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-purple-400"><i class="fas fa-satellite-dish w-6 text-center"></i> 數據採集詳解 (含代碼)</a>
            <a href="#edge-impulse" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-blue-400"><i class="fas fa-brain w-6 text-center"></i> Edge Impulse 訓練指南</a>
            <a href="#deployment" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-red-400"><i class="fas fa-rocket w-6 text-center"></i> 部署與運行 (含代碼)</a>
            <a href="#system-verification" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-orange-400"><i class="fas fa-stethoscope w-6 text-center"></i> 驗證與除錯 (Debug MSG)</a>
            <a href="#hardware-analysis" class="nav-link block px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-cyan-400"><i class="fas fa-chart-pie w-6 text-center"></i> 開發板算力分析 (雙平台)</a>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-tech-600 flex items-center justify-center text-white font-bold text-xs">M</div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-white">Marlon</p>
                        <p class="text-xs text-slate-500">Engineer</p>
                    </div>
                </div>
                <!-- Desktop Theme Toggle -->
                <button id="desktop-theme-toggle" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-yellow-400 transition-colors focus:outline-none" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto pt-16 md:pt-0 scroll-smooth bg-gray-50 dark:bg-slate-950">
        <div class="max-w-6xl mx-auto px-6 py-10 md:py-16">
            
            <!-- Header Section -->
            <header class="mb-12 border-b border-gray-200 dark:border-slate-800 pb-8">
                <div class="inline-block bg-tech-100 text-tech-800 dark:bg-tech-900 dark:text-tech-100 px-3 py-1 rounded-full text-xs font-bold mb-4">ENGINEERING REPORT v3.2 (FULL)</div>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-slate-100 leading-tight mb-4">
                    Project: EdgeVox<br>
                    <span class="text-tech-600 dark:text-tech-400">雙平台邊緣 AI 系統深度報告 (全量版)</span>
                </h1>
                <p class="text-lg text-slate-600 dark:text-slate-400 leading-relaxed">
                    本報告詳述了基於 <strong>ESP32-S3</strong> (語音控制) 與 <strong>Ameba Mini</strong> (影像 AI) 構建的完整邊緣運算生態系。完整收錄數據採集代碼、部署代碼、硬體接線圖及算力分析。
                </p>
            </header>

            <!-- 1. Summary -->
            <section id="summary" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">1</span>
                    執行摘要與市場背景分析
                </h2>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-slate-800 transition-colors">
                    <p class="mb-4 text-gray-700 dark:text-slate-300 leading-7">
                        <strong>Project: EdgeVox</strong> 採用雙平台架構策略，以滿足物聯網產品對「語音互動」與「高階影像處理」的不同需求。
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="border-l-4 border-tech-500 pl-4 py-2 bg-tech-50 dark:bg-slate-800/50">
                            <p class="font-medium text-tech-900 dark:text-tech-100 mb-1">平台 A: ESP32-S3</p>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li><strong>定位</strong>：低成本、語音交互核心</li>
                                <li><strong>優勢</strong>：Arduino 生態豐富、LCD 驅動成熟</li>
                                <li><strong>用途</strong>：離線語音識別、中控面板</li>
                            </ul>
                        </div>
                        <div class="border-l-4 border-ameba-500 pl-4 py-2 bg-purple-50 dark:bg-slate-800/50">
                            <p class="font-medium text-purple-900 dark:text-purple-100 mb-1">平台 B: Ameba Mini (AMB82-mini)</p>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li><strong>定位</strong>：高性能、影像 AI 核心</li>
                                <li><strong>優勢</strong>：內建 NPU (0.4 TOPS)、128MB DDR</li>
                                <li><strong>用途</strong>：人臉識別、物件偵測、1080p 串流</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. Hardware (ESP32-S3) -->
            <section id="hardware" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">2</span>
                    ESP32-S3 硬體架構 (語音/顯示)
                </h2>
                
                <!-- Core Components (Shared) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-microchip text-red-500 text-xl mr-2"></i>
                            <h3 class="font-bold text-slate-800 dark:text-slate-200">ESP32-S3 SoC</h3>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-slate-400">雙核 240MHz, 8MB PSRAM, AI 加速</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-microphone-lines text-green-500 text-xl mr-2"></i>
                            <h3 class="font-bold text-slate-800 dark:text-slate-200">INMP441 Mic</h3>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-slate-400">I2S 全向性 MEMS, 高 SNR</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-volume-high text-purple-500 text-xl mr-2"></i>
                            <h3 class="font-bold text-slate-800 dark:text-slate-200">MAX98357A Amp</h3>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-slate-400">3.2W Class-D, I2S 輸入</p>
                    </div>
                </div>

                <!-- Display Options -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Option A -->
                    <div class="bg-blue-50 dark:bg-blue-900/10 p-6 rounded-xl border border-blue-200 dark:border-blue-800 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-3 py-1 rounded-bl-lg font-bold">OPTION A</div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-200 mb-2">SSD1306 OLED</h3>
                        <ul class="space-y-1 text-sm text-gray-600 dark:text-slate-400">
                            <li>• 尺寸: 0.96吋 (單色)</li>
                            <li>• 介面: I2C (GPIO 8/9)</li>
                            <li>• 優點: 省電、接線少</li>
                        </ul>
                    </div>

                    <!-- Option B -->
                    <div class="bg-purple-50 dark:bg-purple-900/10 p-6 rounded-xl border border-purple-200 dark:border-purple-800 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-purple-500 text-white text-xs px-3 py-1 rounded-bl-lg font-bold">OPTION B</div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-200 mb-2">ILI9341 TFT LCD</h3>
                        <ul class="space-y-1 text-sm text-gray-600 dark:text-slate-400">
                            <li>• 尺寸: 2.8吋 (彩色)</li>
                            <li>• 介面: SPI (GPIO 3/46...)</li>
                            <li>• 優點: 視覺豐富、大螢幕</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- 2.1 Display Matrix -->
            <section id="display-matrix" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">2.1</span>
                    顯示方案決策矩陣 (Decision Matrix)
                </h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-800">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-slate-300 font-bold">
                            <tr>
                                <th class="px-6 py-3">比較項目</th>
                                <th class="px-6 py-3 text-blue-600 dark:text-blue-400">方案 A: SSD1306 (OLED)</th>
                                <th class="px-6 py-3 text-purple-600 dark:text-purple-400">方案 B: ILI9341 (LCD)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-slate-700 text-gray-600 dark:text-slate-400">
                            <tr>
                                <td class="px-6 py-3 font-medium">解析度</td>
                                <td class="px-6 py-3">128 x 64 (低)</td>
                                <td class="px-6 py-3">240 x 320 (高)</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">色彩</td>
                                <td class="px-6 py-3">單色 (白/藍/黃)</td>
                                <td class="px-6 py-3">16-bit 全彩 (RGB565)</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">通訊介面</td>
                                <td class="px-6 py-3">I2C (2 線)</td>
                                <td class="px-6 py-3">SPI (5-6 線)</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">佔用 GPIO</td>
                                <td class="px-6 py-3">2 個 (SDA, SCL)</td>
                                <td class="px-6 py-3">5 個 (CLK, MOSI, CS, DC, RST)</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">功耗 (Typ.)</td>
                                <td class="px-6 py-3">20mA (極低)</td>
                                <td class="px-6 py-3">100-150mA (需背光)</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">推薦應用</td>
                                <td class="px-6 py-3">可攜式、電池供電設備</td>
                                <td class="px-6 py-3">固定式中控、插電設備</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 3. Schematic & PCB -->
            <section id="schematic" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">3</span>
                    電路原理與 PCB 佈局指南
                </h2>

                <!-- Pinout Table -->
                <div class="overflow-x-auto mb-8 rounded-lg border border-gray-200 dark:border-slate-800">
                    <h3 class="font-bold text-lg mb-4 text-slate-700 dark:text-slate-200 px-1">ESP32-S3-WROOM-1 完整引腳分配表</h3>
                    <table class="min-w-full bg-white dark:bg-slate-900">
                        <thead class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-semibold text-xs uppercase tracking-wider">
                            <tr>
                                <th class="px-6 py-3 text-left">模組</th>
                                <th class="px-6 py-3 text-left">訊號名稱</th>
                                <th class="px-6 py-3 text-left">ESP32 GPIO</th>
                                <th class="px-6 py-3 text-left">備註</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-slate-800 text-sm">
                            <!-- Mic -->
                            <tr class="hover:bg-gray-50 dark:hover:bg-slate-800">
                                <td class="px-6 py-4 font-medium text-green-600 dark:text-green-400">INMP441 (Mic)</td>
                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">WS / SCK / SD</td>
                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">42 / 41 / 42</td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-400">I2S0 介面</td>
                            </tr>
                            <!-- Amp -->
                            <tr class="hover:bg-gray-50 dark:hover:bg-slate-800">
                                <td class="px-6 py-4 font-medium text-purple-600 dark:text-purple-400">MAX98357A (Amp)</td>
                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">LRCK / BCLK / DIN</td>
                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">41 / 40 / 39</td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-400">I2S1 介面</td>
                            </tr>
                            <!-- Option A: OLED -->
                            <tr class="bg-blue-50/50 dark:bg-blue-900/10 hover:bg-blue-100 dark:hover:bg-blue-900/20">
                                <td class="px-6 py-4 font-medium text-blue-600 dark:text-blue-400">SSD1306 (OLED)</td>
                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">SDA / SCL</td>
                                <td class="px-6 py-4 font-mono font-bold text-slate-800 dark:text-slate-200">8 / 9</td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-400">I2C 介面 (方案 A)</td>
                            </tr>
                            <!-- Option B: LCD -->
                            <tr class="bg-purple-50/50 dark:bg-purple-900/10 hover:bg-purple-100 dark:hover:bg-purple-900/20">
                                <td class="px-6 py-4 font-medium text-purple-600 dark:text-purple-400">ILI9341 (LCD)</td>
                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">CLK / MOSI / CS / DC / RST</td>
                                <td class="px-6 py-4 font-mono font-bold text-slate-800 dark:text-slate-200">3 / 46 / 14 / 47 / 21</td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-400">SPI 介面 (方案 B)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Design Rules -->
                <div class="space-y-4">
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-600 p-4">
                        <h4 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>PCB 關鍵準則</h4>
                        <ul class="list-disc list-inside text-sm text-yellow-800 dark:text-yellow-100/80 space-y-1">
                            <li><strong>電源樹 (Power Tree)：</strong> MAX98357A 建議使用 5V (VBUS) 供電以保證功率。INMP441 需透過 LC 濾波器隔離數位雜訊。</li>
                            <li><strong>星型接地 (Star Grounding)：</strong> 類比地與功率地應在電源入口單點連接，避免數位迴路干擾。</li>
                            <li><strong>天線淨空區：</strong> ESP32-S3 天線周圍 15mm 嚴禁鋪銅，麥克風應遠離天線以防 TDMA 噪音 (217Hz)。</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- 4. Acoustics -->
            <section id="acoustic" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">4</span>
                    聲學結構工程設計
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-lg border border-gray-200 dark:border-slate-800">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 mb-2">1. 氣密性設計</h3>
                        <p class="text-sm text-gray-600 dark:text-slate-400">
                            使用橡膠或 PORON® 泡棉墊圈將 INMP441 緊密壓合外殼。防止「聲短路」導致 AEC 演算法失效。
                        </p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-lg border border-gray-200 dark:border-slate-800">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 mb-2">2. 獨立後腔</h3>
                        <p class="text-sm text-gray-600 dark:text-slate-400">
                            揚聲器必須擁有獨立密封後腔 (Back Volume)，實現與麥克風的物理隔離並提升低頻。
                        </p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-lg border border-gray-200 dark:border-slate-800">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 mb-2">3. 減震安裝</h3>
                        <p class="text-sm text-gray-600 dark:text-slate-400">
                            使用軟性矽膠懸浮固定揚聲器，切斷震動通過外殼傳導至麥克風的路徑。
                        </p>
                    </div>
                </div>
            </section>

            <!-- 5. Software -->
            <section id="software" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">5</span>
                    軟體架構與 AI 演算法流程
                </h2>
                
                <div class="bg-slate-900 dark:bg-black text-white p-6 rounded-lg mb-6 overflow-x-auto shadow-inner">
                    <p class="font-mono text-sm text-green-400 mb-2">// Audio Pipeline Data Flow</p>
                    <div class="flex items-center space-x-2 text-sm font-mono whitespace-nowrap">
                        <span class="bg-slate-700 px-3 py-1 rounded border border-slate-600">[INMP441]</span>
                        <i class="fas fa-arrow-right text-gray-500"></i>
                        <span class="bg-slate-700 px-3 py-1 rounded border border-slate-600">I2S DMA</span>
                        <i class="fas fa-arrow-right text-gray-500"></i>
                        <span class="bg-blue-600/80 px-3 py-1 rounded border border-blue-400">AFE (AEC/NS)</span>
                        <i class="fas fa-arrow-right text-gray-500"></i>
                        <span class="bg-purple-600/80 px-3 py-1 rounded border border-purple-400">Edge Impulse Model</span>
                        <i class="fas fa-arrow-right text-gray-500"></i>
                        <span class="bg-gray-600 px-3 py-1 rounded border border-gray-400">Display Logic (OLED/LCD)</span>
                    </div>
                </div>

                <div class="space-y-4 text-gray-700 dark:text-slate-300 leading-relaxed">
                    <p>
                        <strong class="text-slate-900 dark:text-slate-100">核心技術棧：</strong> ESP-IDF + Edge Impulse + Adafruit Libraries。
                    </p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>I2S 優化：</strong> DMA Buffer 建議設定 <code>count=8, len=512</code> 以平衡延遲與抗抖動。</li>
                        <li><strong>雙模顯示：</strong> 代碼使用 <code>#ifdef USE_ILI9341</code> 進行條件編譯，一套代碼支援兩種硬體。</li>
                        <li><strong>雙核分配：</strong> 核心 0 負責 I2S/Audio，核心 1 負責 AI 推理與顯示刷新。</li>
                    </ul>
                </div>
            </section>

             <!-- 6. Power -->
             <section id="power" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">6</span>
                    電源管理
                </h2>
                <div class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="font-bold text-lg text-slate-700 dark:text-slate-200">功耗分析比較</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/10 rounded border border-blue-100 dark:border-blue-900">
                            <p class="text-xs text-gray-500 dark:text-slate-400 uppercase">方案 A (OLED)</p>
                            <p class="text-xl font-bold text-blue-600 dark:text-blue-400">~150 mA</p>
                            <p class="text-xs text-gray-400 mt-1">一般運作</p>
                        </div>
                        <div class="p-4 bg-purple-50 dark:bg-purple-900/10 rounded border border-purple-100 dark:border-purple-900">
                            <p class="text-xs text-gray-500 dark:text-slate-400 uppercase">方案 B (LCD)</p>
                            <p class="text-xl font-bold text-purple-600 dark:text-purple-400">~300 mA</p>
                            <p class="text-xs text-gray-400 mt-1">一般運作 (含背光)</p>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-600 dark:text-slate-400">
                        <strong>Deep Sleep：</strong> < 20 µA (兩方案皆同，需關閉週邊電源)。
                    </div>
                </div>
            </section>

            <!-- 7. Production -->
            <section id="production" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">7</span>
                    量產製造 (MP Plan)
                </h2>

                <div class="mb-8">
                    <h3 class="font-bold text-lg mb-4 text-slate-700 dark:text-slate-200">10k 量產 BOM 成本估算</h3>
                    <table class="min-w-full text-sm text-left text-gray-500 dark:text-slate-400 border border-gray-200 dark:border-slate-800">
                        <thead class="text-xs text-gray-700 dark:text-slate-300 uppercase bg-gray-50 dark:bg-slate-800">
                            <tr>
                                <th class="px-6 py-3">元件</th>
                                <th class="px-6 py-3">規格</th>
                                <th class="px-6 py-3 text-right">方案 A (OLED)</th>
                                <th class="px-6 py-3 text-right">方案 B (LCD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white dark:bg-slate-900 border-b dark:border-slate-800">
                                <td class="px-6 py-4 font-medium text-gray-900 dark:text-slate-200">ESP32-S3-WROOM-1</td>
                                <td class="px-6 py-4">N16R8</td>
                                <td class="px-6 py-4 text-right">$3.10</td>
                                <td class="px-6 py-4 text-right">$3.10</td>
                            </tr>
                            <tr class="bg-white dark:bg-slate-900 border-b dark:border-slate-800">
                                <td class="px-6 py-4 font-medium text-gray-900 dark:text-slate-200">INMP441</td>
                                <td class="px-6 py-4">MEMS Mic</td>
                                <td class="px-6 py-4 text-right">$0.65</td>
                                <td class="px-6 py-4 text-right">$0.65</td>
                            </tr>
                            <tr class="bg-white dark:bg-slate-900 border-b dark:border-slate-800">
                                <td class="px-6 py-4 font-medium text-gray-900 dark:text-slate-200">顯示模組</td>
                                <td class="px-6 py-4">OLED / LCD</td>
                                <td class="px-6 py-4 text-right">$1.10</td>
                                <td class="px-6 py-4 text-right">$3.50</td>
                            </tr>
                            <tr class="bg-gray-50 dark:bg-slate-800 border-b dark:border-slate-700">
                                <td class="px-6 py-4 font-bold text-gray-900 dark:text-white" colspan="2">總計 (BOM Cost)</td>
                                <td class="px-6 py-4 text-right font-bold text-green-600 dark:text-green-400">~$6.10</td>
                                <td class="px-6 py-4 text-right font-bold text-purple-600 dark:text-purple-400">~$8.50</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 8. Terminology Cheat Sheet -->
            <section id="terminology" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">8</span>
                    ESP32 語音辨識術語速查表
                </h2>
                
                <!-- 8.1 Core Terms -->
                <div class="mb-10">
                    <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center">
                        <i class="fas fa-bullseye text-red-500 mr-2"></i> 核心技術四件套 (優先記憶)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-white dark:bg-slate-900 rounded-lg border-l-4 border-red-500 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-lg text-slate-900 dark:text-white">ASR</span>
                                <span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded">辨識核心</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Automatic Speech Recognition<br>自動語音辨識，將語音訊號轉為文字。</p>
                        </div>
                        <div class="p-4 bg-white dark:bg-slate-900 rounded-lg border-l-4 border-blue-500 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-lg text-slate-900 dark:text-white">KWS</span>
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">喚醒</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Keyword Spotting<br>關鍵詞偵測，低功耗檢測喚醒詞 (如 "Hi, ESP")。</p>
                        </div>
                        <div class="p-4 bg-white dark:bg-slate-900 rounded-lg border-l-4 border-green-500 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-lg text-slate-900 dark:text-white">VAD</span>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">偵測</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Voice Activity Detection<br>語音活動檢測，判斷是否有「人聲」存在，過濾靜音。</p>
                        </div>
                        <div class="p-4 bg-white dark:bg-slate-900 rounded-lg border-l-4 border-purple-500 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-lg text-slate-900 dark:text-white">MFCC</span>
                                <span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">特徵</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Mel-Frequency Cepstral Coefficients<br>梅爾頻率倒譜係數，模仿人類聽覺提取的音頻特徵。</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 15. Ameba Mini Specs -->
            <section id="ameba-mini" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-ameba-600 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">15</span>
                    Ameba Mini (AMB82-mini) 系統架構
                </h2>
                
                <!-- Main Spec Card -->
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800 mb-8 shadow-sm">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-microchip text-ameba-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200">RTL8735B (Ameba Pro2) SoC</h3>
                            <p class="text-sm text-gray-500 dark:text-slate-400">IoT AI Camera 專用晶片</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <ul class="space-y-3 text-sm text-gray-700 dark:text-slate-300">
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mt-1 mr-2"></i> <span><strong>CPU:</strong> Arm v8-M 32-bit @ 500MHz</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mt-1 mr-2"></i> <span><strong>NPU:</strong> 0.4 TOPS (CNN 加速器)</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mt-1 mr-2"></i> <span><strong>Memory:</strong> 128 MB DDR2/3L (板載)</span></li>
                            <li class="flex items-start"><i class="fas fa-check text-green-500 mt-1 mr-2"></i> <span><strong>Wi-Fi:</strong> 雙頻 2.4GHz + 5GHz (1T1R)</span></li>
                        </ul>
                        <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded text-sm text-gray-600 dark:text-slate-400">
                            <h4 class="font-bold mb-2">關鍵優勢 (vs ESP32):</h4>
                            <p class="mb-1">• <strong>128MB DDR:</strong> 可處理大型影像與複雜 AI 模型。</p>
                            <p class="mb-1">• <strong>NPU 加速:</strong> 影像識別快 10-100 倍。</p>
                            <p>• <strong>硬體編碼:</strong> 支援 H.264/H.265 1080p 串流。</p>
                        </div>
                    </div>
                </div>

                <!-- VMS Expansion -->
                <div class="bg-purple-50 dark:bg-purple-900/10 p-6 rounded-xl border border-purple-200 dark:border-purple-800 mb-8">
                    <h3 class="text-lg font-bold text-purple-800 dark:text-purple-300 mb-4">
                        <i class="fas fa-plug mr-2"></i> VMS 擴充板功能
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white dark:bg-slate-900 p-3 rounded shadow-sm">
                            <span class="block font-bold text-slate-800 dark:text-slate-200 mb-1">電源管理</span>
                            <span class="text-gray-600 dark:text-slate-400">內建 18650 電池座與充電模組，支援可攜式應用。</span>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-3 rounded shadow-sm">
                            <span class="block font-bold text-slate-800 dark:text-slate-200 mb-1">周邊介面</span>
                            <span class="text-gray-600 dark:text-slate-400">I2C LCD (1.3") 接口、音頻功放電路。</span>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-3 rounded shadow-sm">
                            <span class="block font-bold text-slate-800 dark:text-slate-200 mb-1">外殼</span>
                            <span class="text-gray-600 dark:text-slate-400">專屬綠色 3D 列印外殼，整合鏡頭與喇叭。</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 16. Comparison -->
            <section id="comparison" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">16</span>
                    雙平台對比與選型指南 (Comparison)
                </h2>

                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-800 mb-8">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-slate-300 font-bold">
                            <tr>
                                <th class="px-6 py-3 w-1/4">比較項目</th>
                                <th class="px-6 py-3 w-1/3">ESP32-S3 (語音組)</th>
                                <th class="px-6 py-3 w-1/3 text-purple-600 dark:text-purple-400">Ameba Mini (影像組)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-slate-700 text-gray-600 dark:text-slate-400">
                            <tr>
                                <td class="px-6 py-3 font-medium">主要算力</td>
                                <td class="px-6 py-3">240MHz 雙核</td>
                                <td class="px-6 py-3 font-bold">500MHz 單核 + NPU</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">記憶體 (RAM)</td>
                                <td class="px-6 py-3">512KB + 8MB PSRAM</td>
                                <td class="px-6 py-3 font-bold">128MB DDR</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">影像能力</td>
                                <td class="px-6 py-3">軟體處理 (慢)</td>
                                <td class="px-6 py-3 font-bold">硬體 ISP + 編碼 (1080p)</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">AI 推理</td>
                                <td class="px-6 py-3">TFLite (CPU)</td>
                                <td class="px-6 py-3 font-bold">TFLite + NPU 加速</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-3 font-medium">開發成本</td>
                                <td class="px-6 py-3 text-green-600 font-bold">低 ($10-15)</td>
                                <td class="px-6 py-3">中 ($25-35)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 9. Implementation Guide -->
            <section id="implementation" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">9</span>
                    實作開發指南
                </h2>
                <div class="space-y-8">
                    <!-- 9.1 Hardware & Wiring -->
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800">
                        <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-700 pb-2">
                            <i class="fas fa-plug text-tech-500 mr-2"></i> 硬體接線配置 (Wiring)
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- INMP441 Wiring -->
                            <div>
                                <h4 class="font-bold text-sm text-slate-600 dark:text-slate-400 mb-2 uppercase">A. INMP441 (Mic) → ESP32-S3</h4>
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300">
                                        <tr>
                                            <th class="p-2 text-left">INMP441</th>
                                            <th class="p-2 text-left">ESP32 GPIO</th>
                                            <th class="p-2 text-left">備註</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-slate-700 text-gray-700 dark:text-slate-400">
                                        <tr><td class="p-2 font-mono">WS</td><td class="p-2 font-mono text-green-600">42</td><td>左右聲道選擇</td></tr>
                                        <tr><td class="p-2 font-mono">CLK</td><td class="p-2 font-mono text-green-600">41</td><td>位時鐘</td></tr>
                                        <tr><td class="p-2 font-mono">SD</td><td class="p-2 font-mono text-green-600">40</td><td>音頻數據輸出</td></tr>
                                        <tr><td class="p-2 font-mono">L/R</td><td class="p-2 font-mono text-slate-500">GND</td><td>接地=左聲道</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Display Wiring (Dual Option) -->
                            <div>
                                <h4 class="font-bold text-sm text-slate-600 dark:text-slate-400 mb-2 uppercase">B. Display Wiring (Select One)</h4>
                                
                                <!-- Tab Logic -->
                                <div class="mb-2 border-b border-gray-200 dark:border-slate-700 flex">
                                    <span class="px-3 py-1 text-sm font-bold text-blue-600 border-b-2 border-blue-600">SSD1306 (OLED)</span>
                                    <span class="px-3 py-1 text-sm font-bold text-purple-600">ILI9341 (LCD)</span>
                                </div>

                                <table class="w-full text-sm">
                                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300">
                                        <tr>
                                            <th class="p-2 text-left">Pin</th>
                                            <th class="p-2 text-left">ESP32 GPIO</th>
                                            <th class="p-2 text-left">備註</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-slate-700 text-gray-700 dark:text-slate-400">
                                        <!-- OLED Rows -->
                                        <tr><td class="p-2 font-mono">SDA</td><td class="p-2 font-mono text-blue-600">8</td><td>I2C Data</td></tr>
                                        <tr><td class="p-2 font-mono">SCL</td><td class="p-2 font-mono text-blue-600">9</td><td>I2C Clock</td></tr>
                                        
                                        <!-- LCD Rows -->
                                        <tr class="bg-purple-50 dark:bg-purple-900/10"><td colspan="3" class="p-2 text-xs text-purple-600 text-center">Or Use SPI for LCD: CLK(3), MOSI(46), CS(14), DC(47), RST(21)</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 10. ESP32 Acquisition Deep Dive -->
            <section id="acquisition-deep-dive" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-purple-600 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">10</span>
                    ESP32 數據採集核心詳解 (Acquisition Deep Dive)
                </h2>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800 mb-8">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-slate-800 pb-2">
                        <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200">
                            <i class="fas fa-file-code text-purple-500 mr-2"></i> 專用數據採集代碼 (Data Collection Sketch)
                        </h3>
                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded dark:bg-purple-900 dark:text-purple-200">Phase 1: 僅採集用</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        此代碼專注於音訊採集，透過 USB Serial 發送數據。GPIO 已配置為您的專案設定 (40/41/42)。直接複製貼上即可使用。
                    </p>
                    <pre class="code-block"><code class="language-cpp">/*
 * ESP32-S3 I2S Microphone Data Collection for Edge Impulse
 * Author: Marlon's AI Assistant
 * Hardware: ESP32-S3 + INMP441
 */

#include &lt;driver/i2s.h&gt;

// ===== GPIO 配置 (已適配您的硬體) =====
#define I2S_WS   42    // LRCK
#define I2S_SCK  41    // SCLK
#define I2S_SD   40    // DOUT

// Sampling configuration
#define SAMPLE_RATE 16000
#define SAMPLE_BITS 16
#define I2S_PORT    I2S_NUM_0

void setup() {
    Serial.begin(115200);
    while (!Serial); // Wait for Serial to be ready
    
    Serial.println("Starting I2S Data Collection...");
    
    // I2S Configuration
    i2s_config_t i2s_config = {
        .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
        .sample_rate = SAMPLE_RATE,
        .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
        .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT, // INMP441 L/R grounded = Left
        .communication_format = I2S_COMM_FORMAT_STAND_I2S,
        .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
        .dma_buf_count = 8,
        .dma_buf_len = 512,
        .use_apll = false
    };
    
    // Pin Configuration
    i2s_pin_config_t pin_config = {
        .bck_io_num = I2S_SCK,
        .ws_io_num = I2S_WS,
        .data_out_num = -1, // Not used for mic
        .data_in_num = I2S_SD
    };
    
    // Install and Enable I2S
    if (i2s_driver_install(I2S_PORT, &i2s_config, 0, NULL) != ESP_OK) {
        Serial.println("Failed to install I2S driver");
        return;
    }
    
    if (i2s_set_pin(I2S_PORT, &pin_config) != ESP_OK) {
        Serial.println("Failed to set I2S pins");
        return;
    }
    
    Serial.println("✓ I2S Initialized. Ready for Edge Impulse CLI.");
}

void loop() {
    // Edge Impulse CLI expects raw data over serial
    // We only send data when requested, or stream continuously if using data forwarder
    // For simplicity with data forwarder:
    
    int16_t sample_buffer[512]; // Temporary buffer
    size_t bytes_read = 0;
    
    // Read from I2S
    i2s_read(I2S_PORT, sample_buffer, sizeof(sample_buffer), &bytes_read, portMAX_DELAY);
    
    // Send to Serial (Binary format is efficient, but CLI often uses comma-separated values)
    // For "edge-impulse-data-forwarder", we print values separated by comma
    
    int samples_read = bytes_read / 2; // 16-bit = 2 bytes
    if (samples_read > 0) {
        for (int i = 0; i < samples_read; i++) {
            Serial.println(sample_buffer[i]);
        }
    }
}
</code></pre>
                </div>
            </section>

            <!-- 11. Edge Impulse Training (Expanded) -->
            <section id="edge-impulse" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-slate-800 dark:bg-slate-700 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">11</span>
                    Edge Impulse 模型訓練與優化詳解 (完整步驟)
                </h2>
                
                <!-- 11.1 Detailed Steps -->
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800 mb-8">
                    <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-700 pb-2">
                        <i class="fas fa-list-ol text-blue-500 mr-2"></i> 完整訓練流程清單
                    </h3>
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">Step 1: 專案設置與連接</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li>註冊並登入 Edge Impulse。</li>
                                <li>點擊 <strong>Create new project</strong>，命名為 "ESP32-Voice"。</li>
                                <li>確保電腦安裝了 Edge Impulse CLI (<code>npm install -g edge-impulse-cli</code>)。</li>
                                <li>燒錄上方的「數據採集代碼」到 ESP32。</li>
                                <li>在終端機執行 <code>edge-impulse-data-forwarder</code>。</li>
                                <li>選擇頻率 (16000Hz)，驗證設備在 Dashboard 顯示 "Connected"。</li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">Step 2: 數據採集 (Data Acquisition)</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li>進入 <strong>Data acquisition</strong> 頁面。</li>
                                <li><strong>標籤 (Label):</strong> 輸入 "ON"。</li>
                                <li><strong>長度:</strong> 1000ms (1秒)。</li>
                                <li>點擊 <strong>Start sampling</strong>，對麥克風說 "ON"。重複 50 次。</li>
                                <li>重複步驟，錄製 "OFF" (50次) 和 "NOISE" (背景音, 50次)。</li>
                                <li>點擊 <strong>Dashboard</strong> 下方的 "Rebalance dataset" 確保訓練/測試集為 80/20 分配。</li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">Step 3: Impulse 設計 (Create Impulse)</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li><strong>Window size:</strong> 1000ms。</li>
                                <li><strong>Window increase:</strong> 500ms。</li>
                                <li>新增處理塊: <strong>Audio (MFCC)</strong>。</li>
                                <li>新增學習塊: <strong>Classification (Keras)</strong>。</li>
                                <li>點擊 Save Impulse。</li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">Step 4: 特徵生成 (MFCC)</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li>進入 <strong>MFCC</strong> 頁面，保持預設參數 (Coefficients: 13)。</li>
                                <li>點擊 <strong>Save parameters</strong>。</li>
                                <li>點擊 <strong>Generate features</strong>。</li>
                                <li>觀察 Feature Explorer：不同顏色的點應明顯分開。如果混在一起，需重新錄製更清晰的聲音。</li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">Step 5: 訓練與部署</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 dark:text-slate-300 space-y-1">
                                <li>進入 <strong>Classifier</strong> 頁面。</li>
                                <li>Training cycles: 100。Learning rate: 0.005。</li>
                                <li>啟用 <strong>Data augmentation</strong> (Add noise)。</li>
                                <li>點擊 <strong>Start training</strong>。等待準確率出來 (目標 > 90%)。</li>
                                <li>進入 <strong>Deployment</strong>，選擇 <strong>Arduino Library</strong>，點擊 <strong>Build</strong> 下載 ZIP。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 12. Deployment (Full Code) -->
            <section id="deployment" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-red-500 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">12</span>
                    部署與硬體運行 (Deployment)
                </h2>
                
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800 mb-8">
                    <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-700 pb-2">
                        <i class="fas fa-code-branch text-red-500 mr-2"></i> 完整雙模驅動代碼 (Dual-Mode Code)
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        這是最終的產品級代碼。它整合了 Edge Impulse 推理庫、OLED/LCD 驅動以及 I2S 麥克風讀取。
                        <br><strong>使用前請確保已通過 Arduino IDE 匯入下載的 ZIP 庫。</strong>
                    </p>
                    <div class="bg-slate-50 dark:bg-black p-4 rounded font-mono text-xs overflow-x-auto border border-slate-200 dark:border-slate-700">
                        <pre class="code-block"><code class="language-cpp">/*
 * Project: EdgeVox - Dual Display Voice Recognition
 * Author: Marlon
 * Target: ESP32-S3
 */

// ==========================================
// CONFIGURATION: 選擇您的顯示方案 (只能選一個)
// ==========================================
// #define USE_OLED_SSD1306  // 方案 A: 0.96" OLED
#define USE_LCD_ILI9341   // 方案 B: 2.8" LCD

// Include Standard Libraries
#include &lt;SPI.h&gt;
#include &lt;Wire.h&gt;
#include &lt;Adafruit_GFX.h&gt;
#include &lt;driver/i2s.h&gt;

// Include Edge Impulse Library (Change this to match your zip name)
#include &lt;ESP32-Voice-Commands_inferencing.h&gt;

// --- Display Configuration ---
#ifdef USE_OLED_SSD1306
#include &lt;Adafruit_SSD1306.h&gt;
#define SCREEN_W 128
#define SCREEN_H 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_W, SCREEN_H, &Wire, OLED_RESET);
#endif

#ifdef USE_LCD_ILI9341
#include &lt;Adafruit_ILI9341.h&gt;
#define TFT_CS   14
#define TFT_DC   47
#define TFT_MOSI 46
#define TFT_SCLK 3
#define TFT_RST  21
Adafruit_ILI9341 display = Adafruit_ILI9341(TFT_CS, TFT_DC, TFT_MOSI, TFT_SCLK, TFT_RST);
#endif

// --- I2S Configuration ---
#define I2S_WS    42
#define I2S_SCK   41
#define I2S_SD    40
#define I2S_PORT  I2S_NUM_0
#define SAMPLE_RATE 16000

// Audio Buffer
int16_t sampleBuffer[EI_CLASSIFIER_SLICE_SIZE];

// Function Prototypes
bool microphone_audio_signal_get_data(size_t offset, size_t length, float *out_ptr);
void init_i2s();
void display_results(const char* label, float confidence);

void setup() {
    Serial.begin(115200);
    Serial.println("EdgeVox System Starting...");

    // 1. Initialize Display
#ifdef USE_OLED_SSD1306
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
        Serial.println("OLED Init Failed"); 
        for(;;);
    }
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setTextSize(1);
    display.setCursor(0,0);
    display.println("EdgeVox OLED Ready");
    display.display();
#endif

#ifdef USE_LCD_ILI9341
    display.begin();
    display.setRotation(3); // Landscape
    display.fillScreen(ILI9341_BLACK);
    display.setTextColor(ILI9341_WHITE);
    display.setTextSize(2);
    display.setCursor(10, 10);
    display.println("EdgeVox LCD Ready");
#endif

    // 2. Initialize I2S
    init_i2s();
    
    // 3. Initialize Edge Impulse
    if (EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME != SAMPLE_RATE) {
        Serial.printf("ERR: EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME should be equal to %d\n", SAMPLE_RATE);
        return;
    }
}

void loop() {
    // Record Audio
    size_t bytesRead = 0;
    i2s_read(I2S_PORT, sampleBuffer, EI_CLASSIFIER_SLICE_SIZE * 2, &bytesRead, portMAX_DELAY);

    if (bytesRead == 0) {
        Serial.println("Error: No audio data");
        return;
    }

    // Convert integer audio to float for inference
    signal_t signal;
    signal.total_length = EI_CLASSIFIER_SLICE_SIZE;
    signal.get_data = &microphone_audio_signal_get_data;
    
    // Run Inference
    ei_impulse_result_t result = { 0 };
    EI_IMPULSE_ERROR r = run_classifier(&signal, &result, false);
    
    if (r != EI_IMPULSE_OK) {
        Serial.printf("ERR: Failed to run classifier (%d)\n", r);
        return;
    }

    // Process Results
    const char* best_label = "Uncertain";
    float best_confidence = 0.0;

    for (size_t ix = 0; ix < EI_CLASSIFIER_LABEL_COUNT; ix++) {
        if (result.classification[ix].value > best_confidence) {
            best_confidence = result.classification[ix].value;
            best_label = result.classification[ix].label;
        }
    }

    // Display if confidence is high enough
    if (best_confidence > 0.8) {
        Serial.printf("Detected: %s (%.2f)\n", best_label, best_confidence);
        display_results(best_label, best_confidence);
    }
}

// Helper: Convert int16 to float
bool microphone_audio_signal_get_data(size_t offset, size_t length, float *out_ptr) {
    for (size_t i = 0; i < length; i++) {
        out_ptr[i] = (float)sampleBuffer[offset + i];
    }
    return true;
}

// Helper: I2S Init
void init_i2s() {
    i2s_config_t i2s_config = {
        .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
        .sample_rate = SAMPLE_RATE,
        .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
        .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
        .communication_format = I2S_COMM_FORMAT_STAND_I2S,
        .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
        .dma_buf_count = 8,
        .dma_buf_len = 512,
        .use_apll = false
    };
    i2s_pin_config_t pin_config = {
        .bck_io_num = I2S_SCK,
        .ws_io_num = I2S_WS,
        .data_out_num = -1,
        .data_in_num = I2S_SD
    };
    i2s_driver_install(I2S_PORT, &i2s_config, 0, NULL);
    i2s_set_pin(I2S_PORT, &pin_config);
}

// Helper: Display Update
void display_results(const char* label, float confidence) {
#ifdef USE_OLED_SSD1306
    display.clearDisplay();
    display.setCursor(0, 0);
    display.setTextSize(2);
    display.println(label);
    display.setTextSize(1);
    display.print("Conf: ");
    display.print(confidence * 100);
    display.println("%");
    display.display();
#endif

#ifdef USE_LCD_ILI9341
    // Clear previous text area (optimized for speed)
    display.fillRect(0, 40, 320, 100, ILI9341_BLACK);
    
    display.setCursor(10, 50);
    display.setTextSize(3);
    display.setTextColor(ILI9341_GREEN);
    display.print("CMD: ");
    display.println(label);
    
    display.setCursor(10, 90);
    display.setTextSize(2);
    display.setTextColor(ILI9341_YELLOW);
    display.print("Conf: ");
    display.print(confidence * 100, 1);
    display.println("%");
#endif
}
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 13. System Verification -->
            <section id="system-verification" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-orange-500 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">13</span>
                    系統驗證與除錯訊息 (System Verification & Debug MSG)
                </h2>
                
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800 mb-8">
                    <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-700 pb-2">
                        <i class="fas fa-stethoscope text-orange-500 mr-2"></i> 驗證與測試清單
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        完成硬體組裝後，請務必開啟 Arduino IDE Serial Monitor (115200 baud) 並對照以下訊息進行驗證。
                    </p>

                    <!-- Verification 1 -->
                    <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <h4 class="font-bold text-green-600 dark:text-green-400 mb-2">1. I2S 麥克風驗證 (INMP441)</h4>
                        <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
                            <li><strong>操作：</strong> 上傳採集代碼，打開 Serial Monitor。</li>
                            <li><strong>預期訊息：</strong> <code>✓ I2S initialized</code></li>
                            <li><strong>音頻測試：</strong> 在麥克風前說話。</li>
                            <li><strong>Debug MSG：</strong></li>
                        </ul>
                        <pre class="mt-2 bg-black text-green-400 p-2 rounded text-xs font-mono">
I2S initialized
Ready for data collection...
Audio level: 45    (靜默時，數值低且穩定)
Audio level: 1234  (說話時，數值劇烈跳動)
Audio level: 890   (持續說話)
                        </pre>
                        <p class="text-xs text-red-500 mt-2">若數值一直是 0 或卡在固定值，檢查 WS/SCK/SD 接線。</p>
                    </div>

                    <!-- Verification 2 -->
                    <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">2. 顯示器驗證 (OLED/LCD)</h4>
                        <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
                            <li><strong>操作：</strong> 上傳雙模驅動代碼。</li>
                            <li><strong>預期行為：</strong> 螢幕顯示 "EdgeVox Init..."。</li>
                            <li><strong>Debug MSG (Serial Monitor)：</strong></li>
                        </ul>
                        <pre class="mt-2 bg-black text-blue-400 p-2 rounded text-xs font-mono">
EdgeVox Init...
Display initialized successfully
                        </pre>
                        <p class="text-xs text-red-500 mt-2">若顯示 "OLED Init Failed"，檢查 I2C 地址 (0x3C) 或 SPI 接線。</p>
                    </div>

                    <!-- Verification 3 -->
                    <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <h4 class="font-bold text-purple-600 dark:text-purple-400 mb-2">3. 推理完整週期驗證</h4>
                        <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
                            <li><strong>操作：</strong> 說出命令詞 "ON"。</li>
                            <li><strong>Debug MSG (Serial Monitor)：</strong></li>
                        </ul>
                        <pre class="mt-2 bg-black text-purple-400 p-2 rounded text-xs font-mono">
Starting inference...
Predictions (DSP: 15 ms, Classification: 35 ms):
    ON: 0.95
    OFF: 0.02
    NOISE: 0.03
Recognized: ON
                        </pre>
                    </div>
                </div>
            </section>

            <!-- 14. Hardware Analysis (Dual) -->
            <section id="hardware-analysis" class="mb-16 scroll-mt-24">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center">
                    <span class="bg-cyan-600 text-white w-8 h-8 rounded flex items-center justify-center text-sm mr-3">14</span>
                    開發板算力與記憶體分析 (雙平台)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ESP32 Card -->
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-slate-800 shadow-md">
                        <h3 class="text-xl font-bold text-cyan-700 dark:text-cyan-400 mb-4">
                            <i class="fas fa-microchip mr-2"></i> ESP32-S3-CAM 規格
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b border-gray-100 dark:border-slate-800 pb-2">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Flash (Quad SPI)</span>
                                <span class="text-sm font-bold text-slate-800 dark:text-slate-200">8 MB (or 16 MB)</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-gray-100 dark:border-slate-800 pb-2">
                                <span class="text-sm text-gray-600 dark:text-gray-400">PSRAM (Octal SPI)</span>
                                <span class="text-sm font-bold text-slate-800 dark:text-slate-200">8 MB</span>
                            </div>
                            <div class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded text-xs text-green-700 dark:text-green-300">
                                <i class="fas fa-check-circle mr-1"></i> <strong>結論：</strong> 8MB PSRAM 完美支援語音緩衝與 LCD 雙顯。
                            </div>
                        </div>
                    </div>

                    <!-- Ameba Card (NEW) -->
                    <div class="bg-purple-50 dark:bg-purple-900/10 p-6 rounded-xl border border-purple-200 dark:border-purple-800 shadow-md">
                        <h3 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4">
                            <i class="fas fa-video mr-2"></i> Ameba Mini (RTL8735B) 規格
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b border-purple-100 dark:border-purple-800/30 pb-2">
                                <span class="text-sm text-gray-600 dark:text-gray-400">RAM (DDR2)</span>
                                <span class="text-sm font-bold text-slate-800 dark:text-slate-200">128 MB</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-purple-100 dark:border-purple-800/30 pb-2">
                                <span class="text-sm text-gray-600 dark:text-gray-400">AI Accelerator</span>
                                <span class="text-sm font-bold text-slate-800 dark:text-slate-200">NPU (0.4 TOPS)</span>
                            </div>
                            <div class="mt-4 p-3 bg-purple-100 dark:bg-purple-900/30 rounded text-xs text-purple-800 dark:text-purple-200">
                                <i class="fas fa-bolt mr-1"></i> <strong>結論：</strong> 128MB 記憶體 + NPU 是運行 YOLO 等大型視覺模型的關鍵優勢，遠超 ESP32。
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="mt-20 border-t border-gray-200 dark:border-slate-800 pt-8 text-center text-sm text-gray-500 dark:text-slate-500 pb-12">
                <p>&copy; 2024 Marlon's Engineering Lab. All rights reserved.</p>
                <p class="mt-2">Documentation generated for GitHub Pages.</p>
                <div class="mt-4 flex justify-center space-x-4">
                    <a href="#" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300"><i class="fab fa-github text-xl"></i></a>
                    <a href="#" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300"><i class="fab fa-linkedin text-xl"></i></a>
                </div>
            </footer>

        </div>
    </main>

    <script>
        // --- Theme Toggle Logic ---
        const html = document.documentElement;
        const mobileToggle = document.getElementById('mobile-theme-toggle');
        const desktopToggle = document.getElementById('desktop-theme-toggle');
        const mobileIcon = mobileToggle.querySelector('i');
        const desktopIcon = desktopToggle.querySelector('i');

        // Check Local Storage or System Preference
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
                updateIcons(true);
            } else {
                html.classList.remove('dark');
                updateIcons(false);
            }
        }

        // Update Icons based on theme
        function updateIcons(isDark) {
            const iconClass = isDark ? 'fa-sun' : 'fa-moon';
            mobileIcon.className = `fas ${iconClass}`;
            desktopIcon.className = `fas ${iconClass}`;
        }

        // Toggle Function
        function toggleTheme() {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                updateIcons(false);
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                updateIcons(true);
            }
        }

        mobileToggle.addEventListener('click', toggleTheme);
        desktopToggle.addEventListener('click', toggleTheme);
        
        // Initialize on load
        initTheme();

        // --- Mobile Menu Logic ---
        const btn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');

        btn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        // Close sidebar on link click (mobile)
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                }
            });
        });

        // Smooth active state on scroll
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.nav-link');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 150) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('bg-slate-800', 'text-white');
                if (link.getAttribute('href').includes(current)) {
                    link.classList.add('bg-slate-800', 'text-white');
                }
            });
        });
    </script>
</body>
</html>
